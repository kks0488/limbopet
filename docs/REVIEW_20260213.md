# Limbopet 종합 코드 리뷰 (2026-02-13)

> 7개 영역 병렬 리뷰 결과 통합. D-3 데모(2/16) 기준 우선순위 정리.

## P0 수정 완료 현황 (2026-02-13 04:50)

| # | 이슈 | 파일 | 상태 | 테스트 |
|---|------|------|:----:|:------:|
| 2.3 | 재판 사건 불일치 (관전 vs 결과) | `ArenaService.js:4593~4612` | DONE | 31 passed |
| 2.4 | 투표 카운터 역방향 | `PostService.js:348`, `CommentService.js:202` | DONE | 31 passed |
| 2.5 | Brain worker 프로세스 중단 | `runner.py:25~63` | DONE | py_compile OK |
| 2.6 | demo-seed 토큰 파싱 | `demo-seed.sh:49` | DONE | bash -n OK |
| H1 | TALK 메시지 유실 | `PetStateService.js:544~562` | DONE | 31 passed |

### P1 수정 완료 현황 (2026-02-13 05:00)

| # | 이슈 | 파일 | 상태 | 테스트 |
|---|------|------|:----:|:------:|
| 2.1 | SSRF 방어 (HTTPS 강제 + 사설IP 차단) | `UserBrainProfileService.js:64~97` | DONE | 31 passed |
| 2.2 | Proxy auth 권한 경계 (소유권 검증 + email 마스킹) | `routes/users.js:823~880` | DONE | 31 passed |
| H3 | SSOT 범위 밖 모드 차단 (2모드만 허용) | `ArenaPrefsService.js:40`, `ArenaService.js:186~188` | DONE | 31 passed |
| H6 | 초기 코인 중복 방지 (유니크 인덱스 + ON CONFLICT) | `TransactionService.js:186~206`, `0021_initial_mint_unique.sql` | DONE | 31 passed |
| H5 | 체인 반응 실패 유실 방지 (조건부 마킹) | `CrossSystemEventService.js:590~602` | DONE | 31 passed |

### P2 수정 완료 현황 (2026-02-13 05:30)

| # | 이슈 | 파일 | 상태 | 테스트 |
|---|------|------|:----:|:------:|
| H13 | useNow 1초 전역 리렌더 제거 | `App.tsx:321` (useNow 제거 → on-demand 함수) | DONE | tsc OK |
| H11 | 모달 접근성 (포커스 트랩/복원/ARIA) | `ArenaWatchModal.tsx`, `PostDetailModal.tsx`, `ToastView.tsx`, `TabBar.tsx` | DONE | tsc OK |
| H12 | API 중복 호출 정리 (refreshAll → refreshByTab) | `App.tsx` (8곳 변경 + 알림 폴링 30초) | DONE | tsc OK |
| P2-N | Rate limiter Redis 전환 (옵셔널) | `rateLimit.js` (InMemory/Redis 추상화) | DONE | 31 passed |
| P2-O | Brain 프롬프트/스키마 중복 제거 | `generators/prompts.py` (신규) + 3개 gen 파일 | DONE | py_compile OK |

---

## 1. 전체 요약

| 영역 | 등급 | CRITICAL | HIGH | MEDIUM | LOW |
|------|:----:|:--------:|:----:|:------:|:---:|
| API Routes & Middleware | **D** | 2 | 0 | 6 | 2 |
| Pet & Memory 서비스 | **C** | 0 | 2 | 5 | 0 |
| Arena & 재판 시스템 | **C-** | 1 | 1 | 2 | 1 |
| 소셜 & 월드 시스템 | **C-** | 1 | 2 | 8 | 1 |
| 경제 & 유저 시스템 | **C** | 0 | 4 | 4 | 0 |
| Brain & 인프라 | **C+** | 4 | 0 | 5 | 1 |
| 프론트엔드 (React) | **C+** | 0 | 4 | 8 | 2 |
| **합계** | **C-** | **8** | **13** | **38** | **7** |

**종합 등급: C-** -- 핵심 플로우는 동작하나 보안/데이터 정합성/성능에 즉시 조치가 필요한 결함 다수.

---

## 2. CRITICAL 이슈 (즉시 수정)

### 2.1 보안: SSRF via `base_url` 사용자 입력
- **위치**: `routes/users.js:642`, `UserByokLlmService.js:271-279`
- **문제**: BYOK 사용자가 `base_url`로 내부망/메타데이터 엔드포인트에 서버 요청 유도 가능
- **수정**: HTTPS 강제 + 사설/loopback/link-local 대역 차단 + DNS 재해석 방어

### 2.2 보안: Proxy auth 권한 경계 붕괴
- **위치**: `routes/users.js:812-843`
- **문제**: 로그인 사용자가 다른 사용자의 연결정보 조회/삭제 가능
- **수정**: per-user 소유권 검증 + 응답 필드 최소화

### 2.3 UX 붕괴: 재판 사건 불일치 (관전 vs 결과)
- **위치**: `ArenaService.js:3969-3975` (생성), `:4594-4605` (resolve)
- **문제**: 관전 중 본 사건과 리캡/결과 사건이 다름 (resolve 시 재추첨)
- **수정**: 생성 시 `court_preview`를 resolve까지 고정 사용

### 2.4 데이터: 투표 카운터 역방향 증감
- **위치**: `PostService.js:346-348`, `CommentService.js:200-202`
- **문제**: downvote 시 카운트가 줄어듦 (증감 방향 오류)
- **수정**: `voteField` 선택과 `voteChange` 부호를 일치시키기

### 2.5 인프라: Brain worker 예외 전파로 프로세스 중단
- **위치**: `runner.py:27`, `:42-43`
- **문제**: 네트워크/제출 실패 시 워커 루프 자체가 종료
- **수정**: `pull_job` + 제출 실패를 각각 `try/except` 분리 + backoff

### 2.6 인프라: demo-seed 토큰 파싱 오류
- **위치**: `scripts/demo-seed.sh:49`
- **문제**: `data.token` 경로로 파싱하지만 실제 응답은 top-level `token`
- **수정**: `json.load(...)["token"]`

### 2.7 인프라: 마이그레이션 baseline 오판
- **위치**: `migrate.js:100-103`
- **문제**: `agents` 테이블만으로 baseline 완료 판정 (부분 스키마 오인)
- **수정**: 핵심 테이블 세트 검증 (`agents`, `users`, `events`, `brain_jobs`)

### 2.8 인프라: CLI-onboard 모드 불일치
- **위치**: `cli.py:30`, `onboard.py:109`
- **문제**: CLI는 `proxy` 모드 허용하나 onboard는 미인정
- **수정**: onboard 유효 모드 집합에 `proxy` 추가

---

## 3. HIGH 이슈 (데모 전 수정 권장)

| # | 영역 | 이슈 | 핵심 위치 |
|---|------|------|-----------|
| H1 | Pet/Memory | TALK anti-spam에서 사용자 메시지 유실 (25초 내 연속 발화 시 덮어쓰기) | `PetStateService.js:530-550` |
| H2 | Pet/Memory | DAILY_SUMMARY job 중복 생성 race condition | `PetMemoryService.js:514-581` |
| H3 | Arena | SSOT 범위 밖 모드가 자동 매칭에 유입 가능 | `ArenaPrefsService.js:40`, `ArenaService.js:3926-3939` |
| H4 | Social | 스캔들 중복 방지 race → 알림/의사결정 중복 발행 | `ScandalService.js:181-236` |
| H5 | Social | 체인 반응 실패 이벤트도 `chain_processed=true`로 영구 유실 | `CrossSystemEventService.js:589-592` |
| H6 | Economy | 초기 코인 `INITIAL` 중복 발행 (유니크 제약 없음) | `TransactionService.js:189-196` |
| H7 | Economy | 일일 경제 틱 부분실패 후 복구 불가 (하루 마커가 전역 1건) | `EconomyTickService.js:303-390` |
| H8 | Economy | 스트릭 경고 알림이 전역 기준 → 대다수 유저 미수신 | `StreakService.js:543-555` |
| H9 | Economy | 미션/스트릭 보상 유실 (완료 마킹 후 best-effort) | `DailyMissionService.js:255-297` |
| H10 | Frontend | App 단일 컴포넌트 과대화 (상태/이펙트 집중) | `App.tsx:44-337` |
| H11 | Frontend | 모달 접근성 미구현 (포커스 트랩/복원 없음) | `ArenaWatchModal.tsx`, `PostDetailModal.tsx` |
| H12 | Frontend | API 중복 호출 과다 (refreshAll + 추가 폴링) | `App.tsx:125-150, 397-430` |
| H13 | Frontend | 1초 주기 전역 리렌더 (`useNow`) | `App.tsx:321-323` |

---

## 4. 영역별 핵심 발견

### 4.1 API Routes & Middleware
- Rate limiter가 단일 프로세스 in-memory → 멀티 인스턴스 배포 시 무력화
- UUID/숫자 파라미터 검증 불균일 → 잘못된 입력에 500 반환
- `Boolean("false") === true` 파싱 오류 가능
- 스키마 기반 입력검증(Joi/Zod) 전면 부재

### 4.2 Pet & Memory
- ARENA_DEBATE day 정규식 이스케이프 오류로 day 항상 null
- Proxy LLM 호출에 `max_tokens` 미설정 → 비용/지연 비예측
- 하루 이벤트 집계 기준 world day / DB date 혼용

### 4.3 Arena & 재판
- 동점 처리에서 A측 자동 우선 (`aScore >= bScore`)
- `VoteService.getVotes`에 `queryAll` 미import → ReferenceError
- Showrunner에 동결 시스템(선거/결사/연구소) 참조 잔존

### 4.4 소셜 & 월드
- 월드 번들 조회 API가 매 호출마다 tick성 부수효과 실행
- 알림 fan-out이 5,000명 순차 처리 → tick 주기 잠식
- `ORDER BY RANDOM()` 반복 → NPC 규모 확장 시 병목
- DM 자동생성 템플릿 3개 고정 → 반복감 빠르게 누적

### 4.5 경제 & 유저
- 정책 세율/소각율이 실제 송금 경로에 미반영 (레버 미작동)
- 일반 송금 API에 idempotency 보장 없음 → 재시도 시 중복 이체
- BYOK `base_url`에 평문 HTTP 허용 (키 유출 위험)

### 4.6 Brain & 인프라
- 프롬프트/출력 스키마가 provider별 파일에 중복 (드리프트 위험)
- JSON 파서 greedy 추출 (`\{.*\}`) → 멀티 중괄호에서 오탐
- `VOTE_DECISION` 후보 ID 검증 없음
- `dev.sh` 마이그레이션 실패 시 자동 `docker compose down -v` (데이터 삭제)
- 시뮬 스크립트 DB 포트 기본값 불일치 (5433 vs 5432)

### 4.7 프론트엔드
- `any` 과다 사용 (App.tsx, ArenaWatchModal, api.ts)
- 훅 의존성 룰 반복 무시 → stale closure 리스크
- 다크모드 미지원 (`color-scheme: light` 고정)
- 진행바 `width` 기반 애니메이션 → reflow 비용

---

## 5. 데모 D-3 기준 우선 조치 리스트

### P0 (데모 전 필수)
1. **재판 사건 불일치 수정** -- 관전자가 보는 사건 = 결과 사건 (2.3)
2. **투표 카운터 수정** -- 피드 신뢰도 직결 (2.4)
3. **Brain worker 복원력** -- 워커 죽으면 AI 응답 전체 중단 (2.5)
4. **demo-seed 수정** -- 데모 시드가 안 돌면 시연 불가 (2.6)
5. **TALK 메시지 유실 방지** -- "기억 인용" 핵심 약속 (H1)

### P1 (데모 직후 수정)
6. SSRF 방어 (2.1)
7. Proxy auth 권한 수정 (2.2)
8. SSOT 범위 밖 모드 차단 (H3)
9. 초기 코인 중복 방지 (H6)
10. 체인 반응 실패 유실 방지 (H5)

### P2 (안정화 단계)
11. App.tsx 분해 + useNow 국소화 (H10, H13)
12. 모달 접근성 (H11)
13. API 중복 호출 정리 (H12)
14. Rate limiter Redis 전환
15. 프롬프트/스키마 중복 제거 (Brain)

---

## 6. 테스트 갭 종합

| 영역 | 필요한 테스트 |
|------|-------------|
| 동시성 | TALK 연타, DAILY_SUMMARY 동시 생성, 스캔들 중복, 코인 중복 발행 |
| 회귀 | 투표 카운터 up/down/score, ARENA_DEBATE day 저장 |
| 복구 | 체인 반응 handler 실패 후 재처리, 경제 틱 부분 실패 복구 |
| 성능 | 월드 틱 알림 fan-out, 랜덤 샘플링, 1초 리렌더 프로파일링 |
| 계약 | ProxyBrainService job_type별 스키마 검증, VoteService.getVotes |
| 접근성 | 모달 포커스 트랩, 토스트 live region, 탭 ARIA |

---

## 7. 아키텍처 관찰

### 강점
- `SKIP LOCKED` 기반 job poll/lease로 워커 경쟁 조건 잘 제어
- `FOR UPDATE` 기반 펫 상태 갱신으로 기본 동시성 안전
- LLM 실패 시 fallback 변론 생성 (서비스 연속성)
- 관계/감정 전파 뼈대 구조 양호

### 구조적 부채
- SSOT 동결 기능 코드가 핵심 경로에 결합 잔존 (Showrunner, WorldTick, Brain generators)
- 입력 검증이 서비스 레이어에 분산 → 라우트 단 일관성 부족
- 프론트엔드 App.tsx 1파일 집중 → 변경 영향 범위 과대
- `any` 타입 부채 → 리팩터링 시 런타임 오류 위험

---

## 8. 리뷰 메타

- **리뷰 일시**: 2026-02-13 04:15~04:25 KST
- **리뷰 방법**: 7개 Codex 인스턴스 병렬 리뷰 → Claude 문서 통합
- **리뷰 범위**: apps/api, apps/web, apps/brain, scripts, migrations, infra
- **제외**: vendor/openclaw, docs/.archive_backup, My project (Unity)
- **개별 리뷰**: `tmp/review-results/part{1-7}-*.md`
